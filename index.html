<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Genesis 3.0 | Executive Intelligence Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=Inter:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020202;
            color: #fafafa;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        .luxury-font { font-family: 'Playfair Display', serif; }
        .gold-gradient {
            background: linear-gradient(135deg, #d4af37, #f9e29c, #b8860b, #e6be8a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .gold-bg { background: linear-gradient(135deg, #d4af37, #b8860b); }
        .gold-border { border: 1px solid rgba(212, 175, 55, 0.3); }
        .card-glass {
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(30px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .nav-link {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }
        .nav-link.active {
            color: #f9e29c;
            border-bottom: 2px solid #d4af37;
            background: rgba(212, 175, 55, 0.08);
        }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 10px; }
        
        #ai-response {
            text-align: justify;
            text-justify: inter-word;
        }
        #ai-response p { margin-bottom: 1.5rem; line-height: 1.9; font-size: 1.05rem; color: #d1d1d1; }
        #ai-response strong {
            color: #f9e29c;
            display: inline-block;
            margin-top: 0.8rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .roman-numeral {
            color: #f9e29c;
            font-family: 'Playfair Display', serif;
            font-size: 1.6rem;
            font-weight: bold;
            display: block;
            margin-top: 3rem;
            border-left: 4px solid #d4af37;
            padding-left: 1.5rem;
            line-height: 1;
        }
        #ai-response h3 { 
            color: #f9e29c; 
            font-family: 'Playfair Display', serif; 
            font-size: 1.8rem; 
            margin-top: 4.5rem; 
            margin-bottom: 1.5rem;
            text-align: left;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
            padding-bottom: 0.8rem;
        }
        
        .overlay-screen {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 4rem 1rem;
        }
        .hidden-screen { display: none !important; }
        .fade-out { opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        .prosbe-branding {
            color: #ffffff;
            text-shadow: 0 0 15px rgba(255,255,255,0.5);
            letter-spacing: 0.2em;
        }
        .security-modal { max-width: 420px; width: 95%; }

        /* Elegant Toast Styling */
        #toast-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            z-index: 3000;
            background: rgba(184, 134, 11, 0.95);
            color: black;
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-weight: 800;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        #toast-notification.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Toast Notification Area -->
    <div id="toast-notification">
        <i data-lucide="alert-octagon" class="w-5 h-5"></i>
        <span id="toast-text">Pemberitahuan Sistem</span>
    </div>

    <!-- Custom Logout Confirmation Modal -->
    <div id="logout-modal" class="overlay-screen hidden-screen" style="z-index: 2000; background: rgba(0,0,0,0.9);">
        <div class="card-glass p-10 rounded-[2.5rem] gold-border security-modal text-center">
            <div class="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-8 border border-red-500/20">
                <i data-lucide="alert-circle" class="text-red-500 w-10 h-10"></i>
            </div>
            <h3 class="luxury-font text-2xl font-bold text-white mb-4 uppercase tracking-tight">Hapus Otoritas?</h3>
            <p class="text-sm text-neutral-400 mb-10 leading-relaxed">Seluruh kunci akses akan dihapus permanen dari perangkat ini. Anda harus melakukan inisialisasi ulang untuk masuk kembali.</p>
            <div class="flex gap-4">
                <button onclick="toggleLogoutModal(false)" class="flex-1 py-5 border border-white/10 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-white/5 transition-all">Batal</button>
                <button onclick="confirmResetPermanently()" class="flex-1 py-5 bg-red-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-red-700 transition-all shadow-xl shadow-red-900/30">Ya, Hapus Kunci</button>
            </div>
        </div>
    </div>

    <!-- Section: Gateway Entry -->
    <div id="api-setup-overlay" class="overlay-screen">
        <div class="card-glass p-10 md:p-16 rounded-[3.5rem] gold-border w-full max-w-xl shadow-2xl relative my-auto border-t-amber-500/30">
            <div class="text-center mb-14">
                <div class="w-24 h-24 gold-bg rounded-[2.5rem] flex items-center justify-center mx-auto mb-8 shadow-[0_0_50px_rgba(212,175,55,0.4)] rotate-3">
                    <i data-lucide="shield-check" class="text-black w-12 h-12"></i>
                </div>
                <h1 class="luxury-font text-4xl md:text-5xl font-extrabold tracking-tighter mb-3 text-white uppercase">
                    YOUTUBE <span class="gold-gradient">GENESIS 3.0</span>
                </h1>
                <p class="text-[11px] text-neutral-500 uppercase tracking-[0.6em] font-black mb-12">Elite Intelligence Suite</p>
                <div class="h-px bg-white/5 w-full"></div>
            </div>
            
            <div class="space-y-10">
                <div class="space-y-4">
                    <div class="flex justify-between items-center px-1">
                        <label class="text-[10px] font-black text-neutral-500 uppercase tracking-widest">Master API Otoritas</label>
                        <span class="text-[9px] text-amber-500/50 font-bold uppercase tracking-widest">Secure Handshake Enabled</span>
                    </div>
                    <input type="password" id="gemini-key-input" placeholder="Masukkan Google AI Studio Key..." 
                        class="w-full bg-white/[0.03] border border-white/10 rounded-[1.5rem] p-7 text-white focus:outline-none focus:border-amber-500 transition-all font-mono text-sm shadow-2xl placeholder:text-neutral-700">
                </div>
                
                <div class="flex flex-col gap-6">
                    <button onclick="validateAndConnect()" id="connect-btn" class="w-full gold-bg text-black font-black py-7 rounded-[2rem] flex items-center justify-center gap-5 hover:brightness-110 active:scale-[0.98] transition-all shadow-[0_20px_40px_-10px_rgba(184,134,11,0.3)] uppercase tracking-[0.3em] text-xs">
                        <span>Verifikasi & Masuk</span>
                        <i data-lucide="zap" class="w-5 h-5"></i>
                    </button>
                    
                    <div class="text-center py-2">
                        <p class="text-[13px] font-extrabold prosbe-branding uppercase tracking-[0.3em]">Made by ProSbe</p>
                    </div>

                    <button onclick="toggleTutorial(true)" class="w-full py-2 text-[10px] font-bold text-neutral-600 hover:text-amber-500 uppercase tracking-[0.2em] flex items-center justify-center gap-3 transition-colors">
                        <i data-lucide="help-circle" class="w-4 h-4"></i>
                        Cara Mendapatkan API Key
                    </button>
                </div>
                <p id="api-error" class="text-red-500 text-[10px] text-center hidden uppercase tracking-widest font-black animate-pulse bg-red-500/5 py-4 rounded-2xl border border-red-500/10"></p>
            </div>

            <!-- Tutorial Panel -->
            <div id="tutorial-panel" class="hidden absolute inset-0 bg-black/98 rounded-[3.5rem] p-12 z-20 custom-scrollbar border border-white/10">
                <div class="flex justify-between items-center mb-12">
                    <h3 class="luxury-font text-2xl font-bold gold-gradient uppercase tracking-tight">Access Protocol</h3>
                    <button onclick="toggleTutorial(false)" class="p-3 bg-white/5 rounded-full text-neutral-500 hover:text-white transition-all">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="space-y-10 text-sm text-neutral-300 leading-relaxed">
                    <div class="flex gap-6">
                        <div class="w-10 h-10 gold-bg rounded-2xl text-black font-black flex items-center justify-center shrink-0 shadow-lg">1</div>
                        <p>Akses portal resmi <a href="https://aistudio.google.com/" target="_blank" class="text-amber-400 underline font-bold italic">Google AI Studio</a>.</p>
                    </div>
                    <div class="flex gap-6">
                        <div class="w-10 h-10 gold-bg rounded-2xl text-black font-black flex items-center justify-center shrink-0 shadow-lg">2</div>
                        <p>Masuk dengan akun <strong>Google</strong> aktif Anda.</p>
                    </div>
                    <div class="flex gap-6">
                        <div class="w-10 h-10 gold-bg rounded-2xl text-black font-black flex items-center justify-center shrink-0 shadow-lg">3</div>
                        <p>Pilih menu <strong>"Get API key"</strong> pada navigasi utama.</p>
                    </div>
                    <div class="flex gap-6">
                        <div class="w-10 h-10 gold-bg rounded-2xl text-black font-black flex items-center justify-center shrink-0 shadow-lg">4</div>
                        <p>Klik <strong>"Create API key in new project"</strong> untuk otorisasi.</p>
                    </div>
                    <div class="flex gap-6">
                        <div class="w-10 h-10 gold-bg rounded-2xl text-black font-black flex items-center justify-center shrink-0 shadow-lg">5</div>
                        <p>Salin (Copy) kunci tersebut dan tempelkan ke kolom inisialisasi Genesis 3.0.</p>
                    </div>
                </div>
                <button onclick="toggleTutorial(false)" class="mt-14 w-full py-6 border border-white/10 hover:bg-white/5 rounded-[1.5rem] text-[10px] font-black uppercase tracking-[0.4em] transition-all">SOP Dimengerti</button>
            </div>
        </div>
    </div>

    <!-- Section: Dashboard Interface -->
    <div id="main-app" class="hidden-screen min-h-screen flex flex-col">
        <header class="border-b border-white/5 bg-black/90 backdrop-blur-3xl sticky top-0 z-50">
            <div class="max-w-screen-2xl mx-auto px-10 py-7 flex justify-between items-center">
                <div class="flex items-center gap-6">
                    <div class="w-14 h-14 gold-bg rounded-2xl flex items-center justify-center shadow-[0_10px_30px_rgba(212,175,55,0.3)]">
                        <i data-lucide="brain-circuit" class="text-black w-8 h-8"></i>
                    </div>
                    <h1 class="luxury-font text-2xl md:text-3xl font-extrabold tracking-tighter text-white uppercase">GENESIS <span class="gold-gradient">3.0</span></h1>
                </div>
                <div class="flex items-center gap-10">
                    <div class="hidden lg:flex items-center gap-4 bg-white/5 px-6 py-3 rounded-full border border-white/10">
                        <div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_15px_rgba(34,197,94,0.7)]"></div>
                        <span class="text-[10px] font-black text-neutral-400 uppercase tracking-widest">Autonomous Intelligence Chain Active</span>
                    </div>
                    <button onclick="toggleLogoutModal(true)" class="text-[10px] font-black text-red-500/80 hover:text-red-500 uppercase tracking-[0.3em] flex items-center gap-3 transition-all group bg-red-500/5 px-6 py-3 rounded-xl border border-red-500/10">
                        <i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-125 transition-transform"></i> Hapus Kunci & Logout
                    </button>
                </div>
            </div>

            <nav class="border-t border-white/5 overflow-x-auto hide-scrollbar bg-white/[0.01]">
                <div class="max-w-screen-2xl mx-auto flex">
                    <button onclick="setTab('viral')" id="tab-viral-btn" class="nav-link active px-12 py-7 flex items-center gap-4 group">
                        <i data-lucide="trending-up" class="w-4 h-4 group-hover:text-amber-400"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest">I. Viral Gen</span>
                    </button>
                    <button onclick="setTab('script')" id="tab-script-btn" class="nav-link px-12 py-7 flex items-center gap-4 group">
                        <i data-lucide="file-text" class="w-4 h-4 group-hover:text-amber-400"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest">II. Script Formula</span>
                    </button>
                    <button onclick="setTab('monetize')" id="tab-monetize-btn" class="nav-link px-12 py-7 flex items-center gap-4 group">
                        <i data-lucide="dollar-sign" class="w-4 h-4 group-hover:text-amber-400"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest">III. Monetize Map</span>
                    </button>
                    <button onclick="setTab('batch')" id="tab-batch-btn" class="nav-link px-12 py-7 flex items-center gap-4 group">
                        <i data-lucide="calendar" class="w-4 h-4 group-hover:text-amber-400"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest">IV. Batch Planner</span>
                    </button>
                    <button onclick="setTab('algorithm')" id="tab-algorithm-btn" class="nav-link px-12 py-7 flex items-center gap-4 group">
                        <i data-lucide="zap" class="w-4 h-4 group-hover:text-amber-400"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest">V. Algo Hack</span>
                    </button>
                    <button onclick="setTab('series')" id="tab-series-btn" class="nav-link px-12 py-7 flex items-center gap-4 group">
                        <i data-lucide="layers" class="w-4 h-4 group-hover:text-amber-400"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest">VI. Series Arch</span>
                    </button>
                    <button onclick="setTab('visual')" id="tab-visual-btn" class="nav-link px-12 py-7 flex items-center gap-4 group border-l border-white/5">
                        <i data-lucide="image" class="w-4 h-4 text-amber-500"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest text-amber-500">VII. Thumbnail AI</span>
                    </button>
                </div>
            </nav>
        </header>

        <main class="flex-1 max-w-screen-xl mx-auto w-full p-10 md:p-20 space-y-20">
            <!-- Strategic Master Input -->
            <div id="input-section" class="card-glass p-12 md:p-16 rounded-[4rem] gold-border relative overflow-hidden shadow-2xl">
                <div class="mb-14 text-center">
                    <h2 id="current-tab-title" class="text-3xl md:text-5xl font-extrabold luxury-font gold-gradient mb-5 uppercase tracking-tighter">Viral Topic Generator</h2>
                    <p id="current-tab-desc" class="text-neutral-400 text-base md:text-lg italic max-w-3xl mx-auto leading-relaxed">"Analisis mendalam potensi viralitas market berbasis data real-time."</p>
                </div>
                
                <div id="master-inputs" class="grid grid-cols-1 md:grid-cols-2 gap-12 transition-all duration-1000">
                    <div class="space-y-5">
                        <label class="text-[11px] font-black text-neutral-500 uppercase tracking-[0.4em] px-3">Global Niche</label>
                        <input type="text" id="master-niche" placeholder="Misal: Finansial & Investasi" class="w-full bg-white/[0.02] border border-white/10 rounded-[2rem] p-7 text-white focus:outline-none focus:border-amber-500 transition-all text-xl shadow-inner">
                    </div>
                    <div class="space-y-5">
                        <label class="text-[11px] font-black text-neutral-500 uppercase tracking-[0.4em] px-3">Target Persona</label>
                        <input type="text" id="master-target" placeholder="Misal: Investor Pemula Gen Z" class="w-full bg-white/[0.02] border border-white/10 rounded-[2rem] p-7 text-white focus:outline-none focus:border-amber-500 transition-all text-xl shadow-inner">
                    </div>
                </div>

                <div id="auto-chain-alert" class="hidden mt-12 p-8 bg-amber-500/[0.03] rounded-3xl border border-amber-500/10 text-center animate-pulse shadow-inner">
                    <p class="text-xs font-black text-amber-500 uppercase tracking-[0.4em]">Autonomous Bridge Active: Master Parameters Synced.</p>
                </div>

                <button onclick="runIntelligence()" id="master-btn" class="mt-14 w-full gold-bg text-black font-black py-8 rounded-[2.5rem] flex items-center justify-center gap-8 hover:brightness-110 active:scale-[0.99] transition-all shadow-[0_30px_60px_-15px_rgba(184,134,11,0.4)] uppercase tracking-[0.4em] text-sm group">
                    <span>Eksekusi Intelijen Otonom</span>
                    <i data-lucide="cpu" class="w-7 h-7 group-hover:rotate-180 transition-transform duration-[1500ms]"></i>
                </button>
            </div>

            <!-- Loader -->
            <div id="loader" class="hidden flex flex-col items-center justify-center py-24">
                <div class="w-24 h-24 border-[6px] border-amber-500/10 border-t-amber-500 rounded-full animate-spin mb-10 shadow-[0_0_50px_rgba(212,175,55,0.25)]"></div>
                <p class="text-xs text-neutral-500 font-black tracking-[0.8em] animate-pulse uppercase text-center">Sinkronisasi Rantai Data Strategis...</p>
            </div>

            <!-- Strategic Report Output -->
            <div id="report-container" class="hidden animate-in fade-in slide-in-from-bottom-16 duration-1000">
                <div class="card-glass p-12 md:p-20 rounded-[5rem] border border-white/10 shadow-[0_50px_100px_-20px_rgba(0,0,0,0.7)]">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-16 pb-12 border-b border-white/5 gap-10">
                        <h3 class="text-xl md:text-3xl font-bold luxury-font text-white uppercase tracking-tighter">Sovereign Intelligence Report</h3>
                        <div class="flex flex-wrap gap-5">
                            <button id="bridge-btn" onclick="nextInChain()" class="hidden px-10 py-4 bg-green-500/10 hover:bg-green-500/20 text-green-400 rounded-full border border-green-500/20 text-[10px] font-black uppercase tracking-[0.3em] transition-all flex items-center gap-4">
                                <i data-lucide="zap" class="w-4 h-4"></i> Lanjutkan Rantai
                            </button>
                            <button onclick="exportToWord()" class="px-10 py-4 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 rounded-full border border-blue-500/20 text-[10px] font-black uppercase tracking-[0.3em] transition-all flex items-center gap-4 shadow-lg shadow-blue-900/10">
                                <i data-lucide="file-text" class="w-4 h-4"></i> Export Word
                            </button>
                            <button onclick="copyToClipboard()" class="px-10 py-4 bg-white/5 hover:bg-white/10 rounded-full border border-white/10 text-[10px] font-black uppercase tracking-[0.3em] transition-all flex items-center gap-4">
                                <i data-lucide="copy" class="w-4 h-4"></i> Salin Strategi
                            </button>
                        </div>
                    </div>
                    <div id="ai-response" class="custom-scrollbar overflow-y-auto max-h-[2000px] pr-10 text-neutral-300"></div>
                </div>
            </div>
        </main>

        <footer class="p-20 text-center border-t border-white/5 opacity-30">
            <p class="text-[10px] text-neutral-600 font-black uppercase tracking-[1.2em] mb-4">Made by ProSbe • Sovereign Intelligence v3.0</p>
            <p class="text-[8px] text-neutral-800 uppercase font-bold tracking-[0.5em]">Executive Level Verification • No Cloud Data Retention</p>
        </footer>
    </div>

    <script>
        let currentTab = 'viral';
        let lastAnalysisResult = null;
        let masterParams = { niche: "", target: "" };
        let memory = { viral: "", script: "" };

        // INITIALIZATION
        window.onload = () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('api-setup-overlay').classList.add('hidden-screen');
                document.getElementById('main-app').classList.remove('hidden-screen');
            }
            lucide.createIcons();
        };

        // --- INJEKSI KODE BARU PAK CEO (DENGAN REFACTORING SOP) ---
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            const text = document.getElementById('toast-text');
            text.innerText = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 5000);
        }

        function triggerSwitchKeyUI() {
            // Mengarahkan kembali ke gerbang login tanpa menghapus master data agar bisa lanjut kerja
            document.getElementById('main-app').classList.add('hidden-screen');
            document.getElementById('api-setup-overlay').classList.remove('hidden-screen', 'fade-out');
            document.getElementById('api-error').innerText = "LIMIT TERCAPAI. SILAKAN INPUT KEY CADANGAN.";
            document.getElementById('api-error').classList.remove('hidden');
        }

        async function validateAndConnect() {
            const key = document.getElementById('gemini-key-input').value.trim();
            if (!key) return;
            const btn = document.getElementById('connect-btn');
            const errorMsg = document.getElementById('api-error');
            
            btn.disabled = true;
            btn.innerText = "Otentikasi Online...";
            errorMsg.classList.add('hidden');

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await res.json();
                
                if (res.ok && data.models) {
                    localStorage.setItem('gemini_api_key', key);
                    document.getElementById('api-setup-overlay').classList.add('fade-out');
                    setTimeout(() => {
                        document.getElementById('api-setup-overlay').classList.add('hidden-screen');
                        document.getElementById('main-app').classList.remove('hidden-screen');
                        lucide.createIcons();
                    }, 500);
                } else {
                    throw new Error(data.error?.message || "Invalid Access Protocol");
                }
            } catch (err) {
                errorMsg.innerText = "Error: Otoritas API Tidak Sah atau Koneksi Terputus.";
                errorMsg.classList.remove('hidden');
                btn.disabled = false;
                btn.innerText = "Coba Akses Ulang";
            }
        }

        function toggleLogoutModal(show) {
            const modal = document.getElementById('logout-modal');
            if (show) modal.classList.remove('hidden-screen');
            else modal.classList.add('hidden-screen');
            lucide.createIcons();
        }

        function confirmResetPermanently() {
            localStorage.removeItem('gemini_api_key');
            sessionStorage.clear();
            location.reload();
        }

        function toggleTutorial(show) {
            const panel = document.getElementById('tutorial-panel');
            if (show) panel.classList.remove('hidden');
            else panel.classList.add('hidden');
            lucide.createIcons();
        }

        // NAVIGATION FLOWS
        const flows = {
            viral: {
                title: "Viral Topic Generator",
                desc: "Riset ide viral berangka Romawi berdasar tren real-time.",
                next: "script",
                prompt: (v1, v2) => `Hasilkan 30 ide YouTube Shorts di niche [${v1}] untuk audiens [${v2}] dengan potensi viralitas tinggi. Gunakan NOMOR ROMAWI (I, II, III... XXX) sebagai penanda setiap ide. Untuk SETIAP ide, tuliskan format label: 
                [NOMOR ROMAWI]
                JUDUL VIDEO: [Isi Judul]
                HOOK: [Isi Hook]
                ALASAN IDE INI VIRAL: [Isi Alasan Strategis]
                FORMAT: [Isi Format Video]
                Tulis narasi profesional mendalam rata kiri-kanan tanpa simbol markdown.`
            },
            script: {
                title: "Script Writing Formula",
                desc: "Otomasi 30 naskah retensi tinggi berdasar data intelijen viral.",
                next: "monetize",
                prompt: (v1, v2) => `Berdasar ide viral ini: [${memory.viral}]. Tuliskan 30 naskah YouTube Shorts komprehensif. Gunakan NOMOR ROMAWI (I-XXX). Format label: 
                [NOMOR ROMAWI]
                JUDUL NASKAH: [Isi Judul]
                DETIK HOOK (0-3 DETIK): [Isi Hook]
                SETUP MASALAH (3-8 DETIK): [Isi Setup]
                VALUE DELIVERY (8-50 DETIK): [Isi Inti]
                CTA: [Isi CTA]
                INSTRUKSI VISUAL: [Isi Arahan Visual]
                Tulis lengkap rata kiri-kanan.`
            },
            monetize: {
                title: "Monetization Map",
                desc: "Blueprint ekosistem profit otomatis dari alur konten Anda.",
                next: "batch",
                prompt: (v1, v2) => `Buat rencana monetisasi untuk niche [${v1}]. Gunakan NOMOR ROMAWI. Format label: 
                [NOMOR ROMAWI]
                STRATEGI UTAMA: [Isi]
                PRODUK/LAYANAN: [Isi]
                ALUR TRAFIK: [Isi]
                PEMICU PSIKOLOGIS: [Isi]
                CTA KONVERSI: [Isi]
                Analisis bisnis rata kiri-kanan.`
            },
            batch: {
                title: "Batch Content Planner",
                desc: "Alur kerja produksi masal satu hari untuk efisiensi total.",
                next: "algorithm",
                prompt: (v1, v2) => `Buat sistem syuting masal 1 hari untuk 30 video. Gunakan NOMOR ROMAWI. Format label: 
                [NOMOR ROMAWI]
                TAHAPAN PRODUKSI: [Isi]
                SHOT LIST: [Isi]
                KEBUTUHAN B-ROLL: [Isi]
                TALKING POINTS: [Isi]
                STRATEGI OUTFIT: [Isi]
                Tulis mendalam rata kiri-kanan.`
            },
            algorithm: {
                title: "Algorithm Hack Guide",
                desc: "Taktik optimasi jangkauan agar konten menembus feed utama.",
                next: "series",
                prompt: (v1, v2) => `Panduan optimasi algoritma niche [${v1}]. Gunakan NOMOR ROMAWI. Format label: 
                [NOMOR ROMAWI]
                POIN OPTIMASI: [Isi]
                ANALISIS DURASI: [Isi]
                FORMULA JUDUL: [Isi]
                STRATEGI HASHTAG: [Isi]
                TAKTIK JAM PERTAMA: [Isi]
                Tulis rata kiri-kanan.`
            },
            series: {
                title: "Series Creator",
                desc: "Transformasi ide menjadi kekayaan intelektual berkelanjutan.",
                next: "visual",
                prompt: (v1, v2) => `Rancang 9 seri berulang untuk niche [${v1}]. Gunakan NOMOR ROMAWI (I-IX). Format label: 
                [NOMOR ROMAWI]
                NAMA SERI: [Isi]
                STRUKTUR EPISODE: [Isi]
                HOOK SPESIFIK: [Isi]
                STRATEGI CLIFFHANGER: [Isi]
                TARGET KOMUNITAS: [Isi]
                Tulis rata kiri-kanan.`
            },
            visual: {
                title: "Thumbnail AI",
                desc: "Protokol visual konsep High-CTR dari hulu ke hilir.",
                next: null,
                prompt: (v1, v2) => `Buat 10 konsep thumbnail High-CTR untuk niche [${v1}]. Gunakan NOMOR ROMAWI (I-X). Format label: 
                [NOMOR ROMAWI]
                KONSEP VISUAL: [Isi]
                FILOSOFI DESAIN: [Isi]
                PSIKOLOGI WARNA: [Isi]
                ELEMEN UTAMA: [Isi]
                Tulis rata kiri-kanan.`
            }
        };

        function setTab(tab) {
            currentTab = tab;
            const t = flows[tab];
            document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`tab-${tab}-btn`);
            if(btn) btn.classList.add('active');
            
            document.getElementById('current-tab-title').innerText = t.title;
            document.getElementById('current-tab-desc').innerText = t.desc;
            
            const inputs = document.getElementById('master-inputs');
            const alertBox = document.getElementById('auto-chain-alert');
            
            if (tab !== 'viral' && masterParams.niche !== "") {
                inputs.classList.add('opacity-10', 'pointer-events-none');
                alertBox.classList.remove('hidden');
            } else {
                inputs.classList.remove('opacity-10', 'pointer-events-none');
                alertBox.classList.add('hidden');
            }
            
            document.getElementById('report-container').classList.add('hidden');
            document.getElementById('bridge-btn').classList.add('hidden');
            lucide.createIcons();
        }

        // --- CORE FETCH LOGIC WITH EXPONENTIAL BACKOFF & 429 HANDLING ---
        async function fetchWithRetry(prompt, apiKey, retries = 5, delay = 1000) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { 
                            parts: [{ text: "Anda adalah Autonomous Intelligence Elite. WAJIB menggunakan format NOMOR ROMAWI. Gunakan format LABEL (Field: Value) secara terpisah. JANGAN gunakan simbol markdown. Hasil sangat rapi, justified rata kiri-kanan. Made by ProSbe." }] 
                        }
                    })
                });

                if (response.status === 429) {
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithRetry(prompt, apiKey, retries - 1, delay * 2);
                    } else {
                        showToast("KUOTA KEY HABIS! Silakan ganti dengan API Key cadangan.");
                        triggerSwitchKeyUI();
                        return null;
                    }
                }

                if (!response.ok) throw new Error("Fetch failed");
                return await response.json();

            } catch (err) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(prompt, apiKey, retries - 1, delay * 2);
                }
                throw err;
            }
        }

        async function runIntelligence() {
            const apiKey = localStorage.getItem('gemini_api_key');
            let v1 = document.getElementById('master-niche').value.trim();
            let v2 = document.getElementById('master-target').value.trim();
            
            if (!apiKey) return;
            if (currentTab === 'viral') {
                if (!v1 || !v2) { alert("Harap isi Niche & Target utama."); return; }
                masterParams.niche = v1; masterParams.target = v2;
            } else {
                v1 = masterParams.niche || v1; v2 = masterParams.target || v2;
            }

            const loader = document.getElementById('loader');
            const reportCont = document.getElementById('report-container');
            const respArea = document.getElementById('ai-response');
            const masterBtn = document.getElementById('master-btn');
            const bridgeBtn = document.getElementById('bridge-btn');

            loader.classList.remove('hidden');
            reportCont.classList.add('hidden');
            masterBtn.disabled = true;

            try {
                const finalPrompt = flows[currentTab].prompt(v1, v2);
                const data = await fetchWithRetry(finalPrompt, apiKey);

                if (!data) return; // Stopped by 429 handling

                let text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    if (currentTab === 'viral') memory.viral = text;
                    if (currentTab === 'script') memory.script = text;
                    if (flows[currentTab].next) bridgeBtn.classList.remove('hidden');

                    // Label Formatting
                    text = text.replace(/(JUDUL VIDEO:|HOOK:|ALASAN IDE INI VIRAL:|FORMAT:|JUDUL NASKAH:|DETIK HOOK \(0-3 DETIK\):|SETUP MASALAH \(3-8 DETIK\):|VALUE DELIVERY \(8-50 DETIK\):|CTA:|INSTRUKSI VISUAL:|STRATEGI UTAMA:|PRODUK\/LAYANAN:|ALUR TRAFIK:|PEMICU PSIKOLOGIS:|CTA KONVERSI:|TAHAPAN PRODUKSI:|SHOT LIST:|KEBUTUHAN B-ROLL:|TALKING POINTS:|STRATEGI OUTFIT:|CATATAN EDITING:|POIN OPTIMASI:|ANALISIS DURASI:|FORMULA JUDUL:|STRATEGI HASHTAG:|TAKTIK JAM PERTAMA:|NAMA SERI:|STRUKTUR EPISODE:|HOOK SPESIFIK:|STRATEGI CLIFFHANGER:|TARGET KOMUNITAS:|KONSEP VISUAL:|FILOSOFI DESAIN:|PSIKOLOGI WARNA:|ELEMEN UTAMA:)/g, '<br><strong>$1</strong>');
                    
                    // Roman Numeral Styling
                    text = text.replace(/(\b[IVXLCDM]+\b\.|\b[IVXLCDM]+\b:)/g, '<span class="roman-numeral">$1</span>');
                    
                    // Header Styling
                    text = text.replace(/(Strategi|Ide|Bagian|Langkah|Konsep|Bab|Seri|Skrip|Naskah) [0-9]/gi, (m) => `<h3>${m}</h3>`);
                    
                    const paragraphs = text.split('\n').filter(p => p.trim() !== "");
                    respArea.innerHTML = paragraphs.map(p => p.includes('<h3>') || p.includes('<span class="roman-numeral">') || p.includes('<strong>') ? p : `<p>${p}</p>`).join('');
                    
                    lastAnalysisResult = { title: flows[currentTab].title, html: respArea.innerHTML };
                    loader.classList.add('hidden');
                    reportCont.classList.remove('hidden');
                    reportCont.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (err) {
                loader.classList.add('hidden');
                showToast("Intelijen Terputus. Periksa API Key atau Koneksi.");
            } finally {
                masterBtn.disabled = false;
                lucide.createIcons();
            }
        }

        function nextInChain() {
            const next = flows[currentTab].next;
            if (next) { setTab(next); runIntelligence(); }
        }

        function exportToWord() {
            if (!lastAnalysisResult) return;
            const content = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'><style>
                    body { font-family: 'Times New Roman', serif; padding: 1in; }
                    h3 { color: #8a6d17; font-size: 16pt; margin-top: 24pt; border-bottom: 1px solid #ddd; padding-bottom: 5pt; }
                    p { text-align: justify; line-height: 1.6; font-size: 11pt; margin-bottom: 14pt; }
                    strong { color: #8a6d17; font-size: 10pt; text-transform: uppercase; }
                    span.roman-numeral { font-size: 15pt; font-weight: bold; color: #8a6d17; display: block; margin-top: 20pt; border-left: 4pt solid #8a6d17; padding-left: 10pt; }
                    .header-box { border-bottom: 3px double #8a6d17; padding-bottom: 15pt; margin-bottom: 40pt; text-align: center; }
                </style></head><body>
                    <div class='header-box'>
                        <h1 style='color: #8a6d17; margin: 0;'>GENESIS EXECUTIVE CHAIN REPORT</h1>
                        <h2 style='margin: 5pt 0;'>${lastAnalysisResult.title}</h2>
                        <p>Niche: ${masterParams.niche} | Target: ${masterParams.target}</p>
                    </div>
                    ${lastAnalysisResult.html}
                </body></html>`;
            const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Genesis_Report_${currentTab}.doc`;
            link.click();
        }

        function copyToClipboard() {
            const text = document.getElementById('ai-response').innerText;
            const el = document.createElement('textarea');
            el.value = text; document.body.appendChild(el);
            el.select(); 
            document.execCommand('copy');
            document.body.removeChild(el);
            const btn = document.querySelector('button[onclick="copyToClipboard()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-4 h-4 text-green-500"></i> Disalin`;
            lucide.createIcons();
            setTimeout(() => { btn.innerHTML = originalText; lucide.createIcons(); }, 2000);
        }
    </script>
</body>
</html>
